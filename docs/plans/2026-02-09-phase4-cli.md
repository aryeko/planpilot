# Phase 4 CLI + Cutover Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Finish Phase 4 and safely cut over the transitional package layout to canonical `planpilot` paths without carrying legacy v1 code into merge.

**Architecture:** Keep CLI as thin L4 wrapper over SDK, then perform a staged repository cutover: remove legacy v1 tree first, migrate transitional source/tests into canonical locations, and finally normalize packaging, docs, scripts, and CI/release workflows.

**Tech Stack:** Python 3.11+, argparse, asyncio, pytest, ruff, mypy, poetry, GitHub Actions, python-semantic-release.

---

## Current status

- Phase 4 implementation is almost complete.
- This plan focuses on what must happen **after** the transitional Phase 4 branch merge.

---

### Task 1: Remove legacy v1 code first (gate)

**Files:**
- Remove: legacy v1 runtime under `src/planpilot/` (except files intentionally retained for cutover wiring)
- Remove: legacy v1 tests under `tests/` that are superseded by v2 tests
- Keep: transitional source/test locations untouched in this task

**Step 1: Snapshot and verify branch state**

Run: `git status --short --branch`
Expected: clean enough to isolate cutover edits.

**Step 2: Identify v1-only modules to delete**

Run: `rg --files src/planpilot tests`
Expected: list of legacy modules/tests targeted for removal.

**Step 3: Remove v1 code and tests**

Delete only legacy implementation and tests that v2 replaces.

**Step 4: Run targeted failure check**

Run: `poetry run pytest -o addopts='' -q`
Expected: failures due to temporary missing canonical package before transitional tree move.

**Step 5: Commit**

```bash
git add -A
git commit -m "refactor: remove legacy v1 code before cutover"
```

### Task 2: Move transitional runtime/tests into canonical paths

**Files:**
- Move: transitional source package path -> `src/planpilot/`
- Move: transitional tests path -> `tests/`
- Remove: stale transitional package/test folders

**Step 1: Perform path migration**

Move the directories and preserve file history where possible.

**Step 2: Rewrite import paths**

Run: `rg -n "transitional_package_name" src tests`
Expected: update imports/references to canonical `planpilot` package path.

**Step 3: Run focused tests**

Run: `poetry run pytest -o addopts='' -v tests/test_cli.py tests/test_sdk.py`
Expected: PASS.

**Step 4: Run full test suite**

Run: `poetry run pytest -v`
Expected: PASS.

**Step 5: Commit**

```bash
git add src tests
git commit -m "refactor: migrate runtime and tests to canonical planpilot paths"
```

### Task 3: Normalize packaging/config/tooling

**Files:**
- Modify: `pyproject.toml`

**Step 1: Update package and script entries**

- keep only `{include = "planpilot", from = "src"}`
- keep only `planpilot = "planpilot.cli:main"`
- remove transitional script entry

**Step 2: Update tool scopes to canonical paths**

- remove transitional lint/test/check tasks
- ensure `mypy`, `coverage`, `ruff` first-party and ignore/exclude paths point to `src/planpilot/...`
- update ariadne-codegen paths from transitional source paths to `src/planpilot/...`

**Step 3: Verify static checks**

Run:
- `poetry run ruff check .`
- `poetry run ruff format --check .`
- `poetry run mypy src/planpilot`

Expected: PASS.

**Step 4: Commit**

```bash
git add pyproject.toml
git commit -m "build: remove dual-package config and finalize canonical tooling paths"
```

### Task 4: Update docs, scripts, and CI/release workflows

**Files:**
- Modify: `README.md`
- Modify: `CONTRIBUTING.md`
- Modify: `RELEASE.md`
- Modify: `docs/architecture.md`, `docs/cli-reference.md`, `docs/how-it-works.md`, `docs/schemas.md` (as needed)
- Modify: `.github/workflows/ci.yml`, `.github/workflows/release.yml`, `.github/workflows/test-release.yml`
- Modify: `.github/pull_request_template.md`
- Verify/adjust: `scripts/smoke-test.sh`

**Step 1: Remove transitional references**

Run: `rg -n "transitional_package_name|transitional_source_path|transitional_tests_path|transitional_check_task|transitional_coverage_task" README.md CONTRIBUTING.md RELEASE.md docs .github scripts pyproject.toml`
Expected: no remaining transitional references, except historical mentions that are intentionally retained.

**Step 2: Align CI with single canonical track**

- remove temporary v2 job/lane
- keep canonical lint/test/typecheck checks
- keep smoke test on `planpilot` import and CLI

**Step 3: Validate workflows and docs consistency**

Run:
- `./scripts/actionlint.sh`
- `poetry run planpilot --help`

Expected: PASS.

**Step 4: Commit**

```bash
git add README.md CONTRIBUTING.md RELEASE.md docs .github scripts
git commit -m "ci(docs): finalize post-cutover docs scripts and workflow references"
```

### Task 5: Final verification and merge readiness

**Files:**
- Verify only

**Step 1: Full project gate**

Run: `poetry run poe check`
Expected: PASS.

**Step 2: Release dry-run gate**

Run manual workflow: `Test Release (dry-run)`.
Expected: semantic-release dry-run computes next version and exits cleanly.

**Step 3: Merge-readiness grep checks**

Run:
- `rg -n "planpilot_v2|src/planpilot_v2|tests/v2" .`

Expected: no active code/config references remain.

**Step 4: Final commit (if needed)**

```bash
git add -A
git commit -m "chore: finalize release readiness after canonical cutover"
```
