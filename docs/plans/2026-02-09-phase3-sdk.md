# Phase 3 SDK Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Implement the v2 SDK composition root (`PlanPilot`, `load_config`, `load_plan`, and public re-exports) exactly as specified in Phase 3 docs.

**Architecture:** Add `sdk.py` as an orchestration-only module that wires existing core modules (auth, provider, renderer, plan loader/validator/hasher, engine), persists sync maps, and exposes convenience load functions. Keep business logic in core modules and validate behavior through targeted SDK tests.

**Tech Stack:** Python 3.11+, pytest/pytest-asyncio, Pydantic models, existing v2 contracts/core modules.

---

### Task 1: Add failing SDK tests

**Files:**
- Create: `tests/v2/test_sdk.py`

1. Write tests for `PlanPilot.from_config` wiring.
2. Write tests for `sync()` happy path, load-plan fallback, sync-map persistence, dry-run `.dry-run` persistence.
3. Write tests for error propagation and provider cleanup (`__aexit__` on error).
4. Write tests for `load_config()` JSON parsing/path resolution and invalid JSON error wrapping.
5. Write tests for `load_plan()` convenience wrapper.

### Task 2: Implement SDK module

**Files:**
- Create: `src/planpilot_v2/sdk.py`

1. Implement `load_config(path)` with absolute path handling, JSON read, Pydantic parse, relative path resolution, and `ConfigError` wrapping.
2. Implement `load_plan(...)` convenience wrapper using `PlanLoader` and `PlanPaths`.
3. Implement `PlanPilot.__init__`, `PlanPilot.from_config`, and `PlanPilot.sync` orchestration:
   - plan load/validate/hash
   - mode branch: dry-run provider vs apply provider with token resolution
   - provider lifecycle management (`async with` in apply mode)
   - `SyncEngine` execution
   - sync-map persistence to apply path or `.dry-run` path

### Task 3: Wire public API exports

**Files:**
- Modify: `src/planpilot_v2/__init__.py`

1. Re-export SDK, config/plan/sync/contracts, factories, and required exceptions per Phase 3 spec.
2. Define explicit `__all__` aligned with public API.

### Task 4: Verify

**Files:**
- Test: `tests/v2/test_sdk.py`
- Test: v2 suite scope impacted by SDK exports

1. Run focused tests for SDK.
2. Run broader v2 tests to catch regressions.
3. Fix issues until green.
