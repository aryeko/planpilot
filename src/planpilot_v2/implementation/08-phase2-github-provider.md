# Phase 2: GitHub Provider

**Layer:** L2 (Core)
**Branch:** `v2/github-provider`
**Phase:** 2 (after contracts; can overlap with Phase 1)
**Dependencies:** Contracts + httpx + ariadne-codegen generated client
**Design doc:** [`../docs/modules/github-provider.md`](../docs/modules/github-provider.md), [`../docs/decisions/001-ariadne-codegen.md`](../docs/decisions/001-ariadne-codegen.md)

---

## Files to Create

| File | Contents |
|------|----------|
| `providers/github/__init__.py` | Exports `GitHubProvider` |
| `providers/github/provider.py` | `GitHubProvider` |
| `providers/github/item.py` | `GitHubItem` |
| `providers/github/models.py` | `GitHubProviderContext`, `ResolvedField` |
| `providers/github/mapper.py` | Utility functions |
| `providers/github/schema.graphql` | Vendored GitHub schema |
| `providers/github/operations/*.graphql` | 12 operation files |
| `providers/github/github_gql/` | Generated by ariadne-codegen |

---

## GitHubProvider

```python
class GitHubProvider(Provider):
    def __init__(self, *, target: str, token: str, board_url: str,
                 label: str, field_config: FieldConfig | None) -> None: ...
```

**`__aenter__` setup:**
1. Initialize generated GraphQL client with token
2. Resolve repo context (repo ID, issue type IDs, resolve/create label)
3. Resolve project context (parse `board_url`, resolve owner type, fetch fields)
4. Discovery and relation capability checks
5. Resolve create-type policy from `FieldConfig`
6. Store in `GitHubProviderContext`

---

## GitHubItem

```python
class GitHubItem(Item):
    async def set_parent(self, parent: Item) -> None:
        """Idempotent. Raises ProviderCapabilityError if unavailable."""

    async def add_dependency(self, blocker: Item) -> None:
        """Idempotent. Raises ProviderCapabilityError if unavailable."""
```

---

## GitHubProviderContext

```python
class GitHubProviderContext(ProviderContext):
    repo_id: str
    label_id: str
    issue_type_ids: dict[str, str]
    project_owner_type: str              # "org" | "user"
    project_id: str | None
    project_item_ids: dict[str, str]     # Mutable cache â€” must be lock-guarded
    status_field: ResolvedField | None
    priority_field: ResolvedField | None
    iteration_field: ResolvedField | None
    size_field_id: str | None
    size_options: list[dict[str, str]]
    supports_sub_issues: bool
    supports_blocked_by: bool
    supports_discovery_filters: bool
    supports_issue_type: bool
    create_type_strategy: str            # "issue-type" | "label"
    create_type_map: dict[str, str]
```

---

## create_item() Multi-Step Workflow

```
1. Create issue (with metadata in body)
2a. Ensure issue type (if strategy=issue-type)
2b. Ensure type label (if strategy=label)
3. Ensure discovery label
4. Ensure project item
5. Ensure project fields (if size/fields configured)
-> Return GitHubItem

On failure after step N: raise CreateItemPartialFailureError
  with created_item_id + completed_steps + retryable
```

Each sub-step must be safe to retry (`ensure_*` semantics).

---

## Mapper Functions

```python
def parse_project_url(url: str) -> tuple[str, str, int]:
    """Extract (owner_type, owner, number). Raises ProjectURLError."""

def resolve_option_id(options: list[dict[str, str]], name: str) -> str | None:
    """Case-insensitive option ID lookup."""

def build_parent_map(data: dict) -> dict[str, str]:
    """Parse sub-issue API response."""

def build_blocked_by_map(data: dict) -> dict[str, set[str]]:
    """Parse blocked-by API response."""
```

---

## Retry and Rate-Limit Policy

| Failure | Retry? | Notes |
|---------|--------|-------|
| Network timeout/reset | Yes | Exponential backoff |
| HTTP 502/503/504 | Yes | Respect `Retry-After` |
| HTTP 429 / rate limit | Yes | `Retry-After` + shared pause |
| GraphQL transient errors | Yes | Parse `errors[*].extensions` |
| GraphQL schema errors | No | Operation mismatch |
| Auth failures | No | Config/token fix needed |

Per-call: max 3 retries, bounded exponential backoff (1s, 2s, 4s) with jitter.

Shared rate-limit pause: `asyncio.Event` + `asyncio.Lock`. All concurrent calls wait when any receives 429. Concurrent 429s extend pause windows, never shorten them.

---

## Codegen Setup

```toml
# pyproject.toml
[tool.ariadne-codegen]
schema_path = "src/planpilot_v2/providers/github/schema.graphql"
queries_path = "src/planpilot_v2/providers/github/operations/"
target_package_name = "github_gql"
target_package_path = "src/planpilot_v2/providers/github/"
async_client = true
include_all_inputs = false
include_all_enums = false
include_comments = "stable"
```

Schema source: [octokit/graphql-schema](https://github.com/octokit/graphql-schema)

---

## GraphQL Operations (12 files)

| Operation File | Purpose |
|---------------|---------|
| `fetch_repo.graphql` | Repo ID, issue types, labels |
| `create_label.graphql` | Bootstrap discovery label |
| `fetch_project.graphql` | Project fields, options |
| `fetch_project_items.graphql` | Issue -> project item map |
| `search_issues.graphql` | Discovery by label + body text |
| `create_issue.graphql` | `createIssue` mutation |
| `update_issue.graphql` | `updateIssue` mutation |
| `add_project_item.graphql` | `addProjectV2ItemById` |
| `update_project_field.graphql` | `updateProjectV2ItemFieldValue` |
| `add_sub_issue.graphql` | `addSubIssue` |
| `add_blocked_by.graphql` | `addBlockedBy` |
| `fetch_relations.graphql` | `parent`, `blockedBy` on Issue |

---

## Connection Pool

```python
self._client = AsyncClient(
    base_url="https://api.github.com/graphql",
    headers={"Authorization": f"Bearer {token}"},
    limits=Limits(max_connections=20, max_keepalive_connections=10),
    timeout=Timeout(30.0),
)
```

---

## Test Strategy

| Test File | Key Cases |
|-----------|-----------|
| `test_provider.py` | Mock httpx transport: `__aenter__` resolves context, `create_item` multi-step workflow, `update_item` applies correct fields, `search_items` with filters, partial failure error |
| `test_item.py` | `set_parent` calls correct mutation, `add_dependency` calls correct mutation, capability gating raises ProviderCapabilityError |
| `test_mapper.py` | `parse_project_url` org/user/invalid, `resolve_option_id` case-insensitive, build_parent_map, build_blocked_by_map |
| `test_models.py` | GitHubProviderContext creation, ResolvedField |
